<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARKADU GENOMA SCOPE - Species Genome Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --scope-bg-color: #0a0c10;
            --scope-text-color: #c9d1d9;
            --scope-glow-color: hsla(190, 100%, 75%, 0.4);
            --scope-focus-color: hsla(210, 100%, 80%, 0.1);
            --scope-grid-color: rgba(40, 50, 70, 0.2);
            --scope-font-mono: 'Fira Code', monospace;
            --bg-color-dark: #21252b;
            --main-text-color: #e0e0e0;
            --border-color: #2a2a3a;
            --accent-color: #00faff;
            --accent-glow: rgba(0, 250, 255, 0.3);
            --intron-color: #444;
            
            /* ARKADU Species Colors */
            --color-png: #d97b8f; --color-mp4: #e8b849; --color-wav: #9d7be8;
            --color-jpg: #d97b8f; --color-json: #6bbd8f; --color-py: #4dd9cc;
            --color-html: #4dd9cc; --color-txt: #6b8a96; --color-mp3: #9d7be8;
            --color-pdf: #e8b849; --color-md: #6bbd8f; --color-unk: #6b8a96;
            
            --width-col-edge: 50px; --width-col-center: 75px; --gap-col-center: 16px;
            --height-codon-band: 24px; --scale-hover: 1.05; --scale-gaze: 1.1;
            --anim-fast: 150ms; --anim-smooth: 350ms;
        }

        * { box-sizing: border-box; }
        html { height: 100%; }
        body {
            height: 100%; margin: 0;
            background-color: var(--scope-bg-color);
            color: var(--scope-text-color);
            font-family: var(--scope-font-mono);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            overflow: hidden;
            background-image: 
                linear-gradient(var(--scope-grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--scope-grid-color) 1px, transparent 1px);
            background-size: 60px 60px;
        }
        
        .scope-container {
            width: 100%; max-width: 1800px;
            height: 85vh; display: flex;
            flex-direction: column; gap: 20px;
        }
        
        header {
            padding: 1rem 5vw;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .header-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title h1 {
            font-size: 1.4rem;
            margin: 0;
            font-weight: 500;
            color: var(--accent-color);
        }
        
        .header-stats {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .header-controls {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .scope-header {
            display: flex; justify-content: space-between;
            align-items: center; padding: 0 5vw 10px;
            width: 100%; color: var(--scope-text-color);
        }
        .scope-header h1 {
            font-size: 1.4rem; margin: 0;
            font-weight: 500;
        }
        .scope-stats {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        #genome-field {
            flex-grow: 1; display: flex;
            align-items: center; gap: 4px;
            padding: 30px 5vw 0 5vw;
            overflow-x: auto; overflow-y: hidden;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #genome-field::-webkit-scrollbar { display: none; }
        
        .genome-column {
            position: relative; flex-shrink: 0;
            display: flex; flex-direction: column;
            gap: 4px; height: 98%;
            width: var(--width-col-edge);
            padding: 10px 0; border-radius: 6px;
            cursor: pointer; scroll-snap-align: center;
            transition: width var(--anim-smooth) ease,
                       transform var(--anim-fast) ease,
                       background-color var(--anim-smooth) ease,
                       box-shadow var(--anim-smooth) ease,
                       margin-left var(--anim-smooth) ease,
                       border-color var(--anim-smooth) ease;
            border: 1px solid transparent;
        }
        
        .genome-column.in-central-zone {
            width: var(--width-col-center);
            margin-left: var(--gap-col-center);
        }
        
        .genome-column.in-gaze-zone .codon-band {
            transform: scale(var(--scale-gaze));
        }
        
        .genome-column.is-focused {
            transform: scale(var(--scale-hover));
            box-shadow: 0 0 25px 5px var(--scope-glow-color);
            background-color: var(--scope-focus-color);
        }
        
        .genome-column.is-focused .genome-id-tag {
            opacity: 1;
            transform: translateY(-10px);
        }
        
        .genome-column.is-inspected {
            width: 450px; max-width: 450px;
            background-color: rgba(10,12,16,0.9);
            backdrop-filter: blur(8px);
            cursor: default; padding: 20px;
            align-items: flex-start;
            border-color: var(--accent-color);
        }
        
        .codon-band-container {
            display: flex; flex-direction: column;
            gap: 2px; width: 100%; height: 100%;
            overflow-y: hidden;
        }
        
        .codon-band {
            width: 100%; height: 22px;
            min-height: 22px; flex-shrink: 0;
            border-radius: 3px; user-select: none;
            display: flex; align-items: center;
            justify-content: center; overflow: hidden;
            position: relative;
            transition: all var(--anim-fast) ease-in-out;
        }
        
        .codon-band-abbr {
            position: absolute; font-weight: 600;
            color: rgba(0,0,0,0.85);
            transition: opacity var(--anim-fast) ease-in-out;
            font-size: 0.75rem; opacity: 0;
        }
        
        .codon-band:hover .codon-band-abbr {
            opacity: 1;
        }
        
        .codon-band.is-intron {
            background-color: transparent !important;
            border: 1px solid var(--scope-grid-color);
        }
        
        .genome-id-tag {
            position: absolute; top: -10px;
            left: 50%; transform: translateX(-50%) translateY(-10px);
            background-color: var(--scope-text-color);
            color: var(--scope-bg-color);
            padding: 3px 10px; border-radius: 4px;
            font-size: 0.9rem; font-weight: 600;
            opacity: 0;
            transition: opacity var(--anim-smooth) ease,
                       transform var(--anim-smooth) ease;
            white-space: nowrap; z-index: 10;
        }
        
        .genome-column:hover .genome-id-tag {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .inspected-info {
            padding: 1rem;
            background-color: rgba(255,255,255,0.05);
            border-radius: 8px; height: 100%;
            display: flex; flex-direction: column;
            justify-content: space-between;
        }
        
        .inspected-header {
            font-weight: 700; font-size: 1.1rem;
            padding-bottom: 0.5rem; margin-bottom: 1rem;
            border-bottom: 1px solid var(--scope-grid-color);
            word-break: break-all;
        }
        
        .inspected-stats {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 1rem;
        }
        
        .inspected-codon-list {
            flex-grow: 1; overflow-y: auto;
            padding: 0.5rem; margin-bottom: 1rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 4px;
            min-height: 100px;
            max-height: 50vh;
        }
        
        .inspected-codon-list::-webkit-scrollbar { width: 6px; }
        .inspected-codon-list::-webkit-scrollbar-track { background: transparent; }
        .inspected-codon-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .codon {
            display: flex; align-items: center;
            padding: 4px 8px; border-radius: 3px;
            margin-bottom: 4px; font-size: 0.9rem;
        }
        
        .codon.intron {
            opacity: 0.5;
            background-color: transparent !important;
            border: 1px dashed var(--border-color);
        }
        
        .codon-type {
            padding: 2px 6px; border-radius: 3px;
            margin-right: 10px; font-weight: 700;
            font-size: 0.8rem; color: #000;
        }
        
        .codon-payload {
            font-family: var(--scope-font-mono);
            color: var(--main-text-color);
            font-size: 0.75rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .codon-filename {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .codon-taxonomy {
            font-size: 0.7rem;
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .inspected-actions {
            display: flex; flex-direction: column;
            gap: 0.5rem;
        }
        
        .inspected-actions button {
            width: 100%; padding: 0.75rem;
            font-family: var(--scope-font-mono);
            font-weight: 700; cursor: pointer;
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .inspected-actions button:hover {
            background-color: var(--accent-color);
            color: var(--bg-color-dark);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="scope-container" id="scope-root">
        <header>
            <div class="header-title">
                <h1> ARKADU GENOMA SCOPE</h1>
                <div class="header-stats" id="header-stats"></div>
            </div>
            <div class="header-controls">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9em;">
                    <span>Group by:</span>
                    <select id="group-by-selector" style="padding:6px 10px; background:var(--bg-color); border:1px solid var(--border-color); color:var(--main-text-color); font-family:var(--scope-font-mono); border-radius:3px; cursor:pointer;">
                        <option value="species">Species (File Type)</option>
                        <option value="kingdom">Kingdom (Top Folder)</option>
                        <option value="size">Size (Largest First)</option>
                    </select>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9em;">
                    <span>Filter:</span>
                    <input type="text" id="filter-input" placeholder="Search species..." style="padding:6px 10px; background:var(--bg-color); border:1px solid var(--border-color); color:var(--main-text-color); font-family:var(--scope-font-mono); border-radius:3px; width:200px;">
                </label>
            </div>
        </header>
        <div id="genome-field">
            <div class="loading">Loading genomes...</div>
        </div>
    </div>

    <script>
        const SPECIES_COLORS = {
            'PNG': 'var(--color-png)', 'MP4': 'var(--color-mp4)', 'WAV': 'var(--color-wav)',
            'JPG': 'var(--color-jpg)', 'JSON': 'var(--color-json)', 'PY': 'var(--color-py)',
            'HTML': 'var(--color-html)', 'TXT': 'var(--color-txt)', 'MP3': 'var(--color-mp3)',
            'PDF': 'var(--color-pdf)', 'MD': 'var(--color-md)', 'UNK': 'var(--color-unk)'
        };

        class GenomaScope {
            constructor(containerElement) {
                this.container = containerElement;
                this.genomeField = this.container.querySelector('#genome-field');
                this.statsEl = document.querySelector('#header-stats');
                this.groupBySelector = document.querySelector('#group-by-selector');
                this.filterInput = document.querySelector('#filter-input');
                this.fullGenomeData = [];
                this.filteredGenomeData = [];
                this.focusedIndex = -1;
                this.inspectedIndex = -1;
                this.groupBy = 'species';
                this.filterText = '';
                this._handleEvent = this._handleEvent.bind(this);
            }

            async loadData() {
                try {
                    const response = await fetch('sys/genoma-sequences.json');
                    const data = await response.json();
                    this.fullGenomeData = data.arkadu_genomes.species_genomes;
                    this._updateStats(data.arkadu_genomes);
                    this._renderField();
                    this._bindEvents();
                    this._focusColumn(Math.floor(this.fullGenomeData.length / 2));
                } catch (error) {
                    this.genomeField.innerHTML = `<div class="loading">Error loading genomes: ${error.message}</div>`;
                }
            }

            _updateStats(arkadu) {
                const totalFiles = arkadu.total_files.toLocaleString();
                const totalGB = (arkadu.total_bytes / 1024 / 1024 / 1024).toFixed(1);
                const totalSpecies = arkadu.total_species;
                this.statsEl.textContent = `${totalSpecies} species • ${totalFiles} files • ${totalGB} GB`;
            }

            _bindEvents() {
                this.genomeField.addEventListener('click', this._handleEvent);
                this.genomeField.addEventListener('mouseover', this._handleEvent);
                document.addEventListener('keydown', this._handleEvent);
                
                // Group by selector
                this.groupBySelector.addEventListener('change', (e) => {
                    this.groupBy = e.target.value;
                    this._applyFiltersAndRender();
                });
                
                // Filter input
                this.filterInput.addEventListener('input', (e) => {
                    this.filterText = e.target.value.toLowerCase();
                    this._applyFiltersAndRender();
                });
            }
            
            _applyFiltersAndRender() {
                // Apply filtering
                let data = this.fullGenomeData;
                
                if (this.filterText) {
                    data = data.filter(g => 
                        g.genome_id.toLowerCase().includes(this.filterText) ||
                        g.species_type.toLowerCase().includes(this.filterText)
                    );
                }
                
                // Apply grouping/sorting
                if (this.groupBy === 'kingdom') {
                    // Group by kingdom (top folder)
                    const kingdoms = {};
                    data.forEach(genome => {
                        genome.sequence.forEach(codon => {
                            const kingdom = codon.payload?.kingdom || 'unknown';
                            if (!kingdoms[kingdom]) {
                                kingdoms[kingdom] = {
                                    genome_id: `kingdom-${kingdom}`,
                                    species_type: kingdom.toUpperCase(),
                                    total_instances: 0,
                                    total_bytes: 0,
                                    color_signature: SPECIES_COLORS[genome.species_type] || 'var(--color-unk)',
                                    sequence: []
                                };
                            }
                            kingdoms[kingdom].sequence.push(codon);
                            kingdoms[kingdom].total_instances++;
                            kingdoms[kingdom].total_bytes += codon.payload?.size_bytes || 0;
                        });
                    });
                    data = Object.values(kingdoms);
                } else if (this.groupBy === 'size') {
                    // Sort by size (largest first)
                    data = [...data].sort((a, b) => b.total_bytes - a.total_bytes);
                }
                
                this.filteredGenomeData = data;
                this._renderField();
                this._focusColumn(Math.floor(data.length / 2));
            }

            _handleEvent(event) {
                const column = event.target.closest('.genome-column');
                const columnIndex = column ? +column.dataset.index : -1;

                switch (event.type) {
                    case 'click':
                        if (columnIndex !== -1 && !event.target.closest('button')) {
                            this._inspectColumn(columnIndex);
                        }
                        break;
                    case 'mouseover':
                        if (column && columnIndex !== this.focusedIndex) {
                            this._focusColumn(columnIndex);
                        }
                        break;
                    case 'keydown':
                        if (document.activeElement !== document.body && document.activeElement !== null) return;
                        if (event.key === 'ArrowRight') {
                            event.preventDefault();
                            this._focusColumn(this.focusedIndex < this.fullGenomeData.length - 1 ? this.focusedIndex + 1 : 0);
                        }
                        if (event.key === 'ArrowLeft') {
                            event.preventDefault();
                            this._focusColumn(this.focusedIndex > 0 ? this.focusedIndex - 1 : this.fullGenomeData.length - 1);
                        }
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            if (this.focusedIndex !== -1) this._inspectColumn(this.focusedIndex);
                        }
                        if (event.key === 'Escape') {
                            event.preventDefault();
                            if (this.inspectedIndex !== -1) {
                                this._collapseColumn(this.inspectedIndex);
                            }
                        }
                        break;
                }
            }

            _renderField() {
                this.genomeField.innerHTML = '';
                const dataToRender = this.filteredGenomeData.length > 0 ? this.filteredGenomeData : this.fullGenomeData;
                dataToRender.forEach((genome, index) => {
                    const columnEl = this._createColumnElement(genome, index);
                    this.genomeField.appendChild(columnEl);
                });
            }

            _createColumnElement(genome, index) {
                const columnEl = document.createElement('div');
                columnEl.className = 'genome-column';
                columnEl.dataset.index = index;
                
                const tagEl = document.createElement('div');
                tagEl.className = 'genome-id-tag';
                tagEl.textContent = genome.genome_id;
                columnEl.appendChild(tagEl);
                
                columnEl.appendChild(this._renderCodonBands(genome.sequence));
                return columnEl;
            }

            _renderCodonBands(sequence) {
                const container = document.createElement('div');
                container.className = 'codon-band-container';
                
                // Sample sequence if too long
                const maxBands = 100;
                const displaySequence = sequence.length > maxBands 
                    ? sequence.slice(0, maxBands) 
                    : sequence;
                
                displaySequence.forEach(codon => {
                    const bandEl = document.createElement('div');
                    bandEl.className = 'codon-band';
                    
                    const color = SPECIES_COLORS[codon.type] || 'var(--color-unk)';
                    
                    const abbrEl = document.createElement('span');
                    abbrEl.className = 'codon-band-abbr';
                    abbrEl.textContent = codon.type;
                    bandEl.appendChild(abbrEl);
                    
                    if (codon.is_intron) {
                        bandEl.classList.add('is-intron');
                        abbrEl.style.color = 'var(--scope-text-color)';
                    } else {
                        bandEl.style.backgroundColor = color;
                    }
                    
                    container.appendChild(bandEl);
                });
                
                return container;
            }

            _inspectColumn(index) {
                if (index === this.inspectedIndex) {
                    this._collapseColumn(index);
                    return;
                }
                
                if (this.inspectedIndex !== -1) {
                    this._collapseColumn(this.inspectedIndex);
                }
                
                this.inspectedIndex = index;
                const columnEl = this.genomeField.children[index];
                const genome = this.fullGenomeData[index];
                const infoEl = this._createInspectedInfoElement(genome);
                
                columnEl.innerHTML = '';
                columnEl.appendChild(infoEl);
                this._updateAllColumnClasses();
                columnEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            _createInspectedInfoElement(genome) {
                const infoEl = document.createElement('div');
                infoEl.className = 'inspected-info';

                const header = document.createElement('div');
                header.className = 'inspected-header';
                header.textContent = genome.genome_id;
                infoEl.appendChild(header);

                const stats = document.createElement('div');
                stats.className = 'inspected-stats';
                const mb = (genome.total_bytes / 1024 / 1024).toFixed(1);
                
                // Get taxonomy from first codon
                const firstCodon = genome.sequence[0];
                const taxonomy = firstCodon?.payload || {};
                
                stats.innerHTML = `
                    <div>Species: <strong>${genome.species_type}</strong></div>
                    <div>Instances: <strong>${genome.total_instances.toLocaleString()}</strong></div>
                    <div>Size: <strong>${mb} MB</strong></div>
                    <div>Color: <strong>${genome.color_signature}</strong></div>
                    ${taxonomy.media_type ? `<div>Media Type: <strong>${taxonomy.media_type}</strong></div>` : ''}
                `;
                infoEl.appendChild(stats);

                const listContainer = document.createElement('div');
                listContainer.className = 'inspected-codon-list';
                
                // Show first 50 codons
                const displaySequence = genome.sequence.slice(0, 50);
                
                displaySequence.forEach(codon => {
                    const color = SPECIES_COLORS[codon.type] || 'var(--color-unk)';
                    const codonEl = document.createElement('div');
                    codonEl.className = 'codon';
                    if (codon.is_intron) codonEl.classList.add('intron');
                    
                    const typeEl = document.createElement('span');
                    typeEl.className = 'codon-type';
                    typeEl.textContent = codon.type;
                    typeEl.style.backgroundColor = color;
                    
                    const payloadEl = document.createElement('div');
                    payloadEl.className = 'codon-payload';
                    payloadEl.title = codon.payload?.path_absolute || '';
                    
                    // Build display with taxonomy
                    const filename = codon.payload?.filename || codon.payload?.path_relative || JSON.stringify(codon.payload).slice(0, 50);
                    const truncated = filename.length > 40 ? filename.slice(0, 37) + '...' : filename;
                    
                    const filenameDiv = document.createElement('div');
                    filenameDiv.className = 'codon-filename';
                    filenameDiv.textContent = truncated;
                    payloadEl.appendChild(filenameDiv);
                    
                    // Add taxonomy if available
                    const taxonomy = [];
                    if (codon.payload?.kingdom) taxonomy.push(codon.payload.kingdom);
                    if (codon.payload?.phylum) taxonomy.push(codon.payload.phylum);
                    if (codon.payload?.class) taxonomy.push(codon.payload.class);
                    
                    if (taxonomy.length > 0 || codon.payload?.size_bytes || codon.payload?.media_type) {
                        const taxonomyDiv = document.createElement('div');
                        taxonomyDiv.className = 'codon-taxonomy';
                        
                        const parts = [];
                        if (taxonomy.length > 0) parts.push(taxonomy.join('/'));
                        if (codon.payload?.media_type) parts.push(codon.payload.media_type);
                        if (codon.payload?.size_bytes) parts.push(`${(codon.payload.size_bytes / 1024 / 1024).toFixed(2)}MB`);
                        
                        taxonomyDiv.textContent = parts.join(' • ');
                        payloadEl.appendChild(taxonomyDiv);
                    }
                    
                    codonEl.appendChild(typeEl);
                    codonEl.appendChild(payloadEl);
                    listContainer.appendChild(codonEl);
                });
                
                if (genome.sequence.length > 50) {
                    const moreEl = document.createElement('div');
                    moreEl.style.textAlign = 'center';
                    moreEl.style.opacity = '0.5';
                    moreEl.style.padding = '0.5rem';
                    moreEl.textContent = `... ${genome.sequence.length - 50} more codons`;
                    listContainer.appendChild(moreEl);
                }
                
                infoEl.appendChild(listContainer);

                const actions = document.createElement('div');
                actions.className = 'inspected-actions';
                
                const exportButton = document.createElement('button');
                exportButton.textContent = 'Export Genome';
                exportButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    this._exportGenome(genome);
                });
                actions.appendChild(exportButton);
                
                const pathsButton = document.createElement('button');
                pathsButton.textContent = 'Copy All Paths';
                pathsButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    this._copyPaths(genome);
                });
                actions.appendChild(pathsButton);
                
                const editorButton = document.createElement('button');
                editorButton.textContent = 'Send to Editor';
                editorButton.style.borderColor = 'var(--accent-color)';
                editorButton.style.color = 'var(--accent-color)';
                editorButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    this._sendToEditor(genome);
                });
                actions.appendChild(editorButton);

                infoEl.appendChild(actions);
                return infoEl;
            }

            _exportGenome(genome) {
                const dataStr = JSON.stringify(genome, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${genome.genome_id}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            _copyPaths(genome) {
                // Extract all absolute paths
                const paths = genome.sequence
                    .filter(codon => !codon.is_intron)
                    .map(codon => codon.payload?.path_absolute)
                    .filter(p => p)
                    .join('\n');
                
                navigator.clipboard.writeText(paths).then(() => {
                    alert(`✅ Copied ${genome.sequence.length} file paths to clipboard!\n\nYou can now:\n- Open in Finder\n- Process with scripts\n- Verify file existence`);
                }).catch(err => {
                    alert(`Error copying: ${err.message}`);
                });
            }

            _sendToEditor(genome) {
                // Store genome AND all genomes in sessionStorage for editor to pick up
                const allGenomesObj = {};
                this.fullGenomeData.forEach(g => {
                    allGenomesObj[g.genome_id] = g;
                });
                
                sessionStorage.setItem('genomaEditorData', JSON.stringify({
                    genome: genome,
                    allGenomes: allGenomesObj,
                    fromScope: true
                }));
                // Open editor in new tab
                window.open('genoma-editor.html', '_blank');
            }

            _collapseColumn(index) {
                if (index < 0) return;
                this.inspectedIndex = -1;
                const columnEl = this.genomeField.children[index];
                const genome = this.fullGenomeData[index];
                
                columnEl.innerHTML = '';
                const tagEl = document.createElement('div');
                tagEl.className = 'genome-id-tag';
                tagEl.textContent = genome.genome_id;
                columnEl.appendChild(tagEl);
                columnEl.appendChild(this._renderCodonBands(genome.sequence));
                
                this._updateAllColumnClasses();
            }

            _focusColumn(index) {
                if (index < 0 || index >= this.fullGenomeData.length) return;
                this.focusedIndex = index;
                const columnEl = this.genomeField.children[index];
                if (columnEl && this.inspectedIndex === -1) {
                    columnEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
                this._updateAllColumnClasses();
            }

            _updateAllColumnClasses() {
                this.genomeField.querySelectorAll('.genome-column').forEach((col, i) => {
                    col.classList.toggle('is-focused', i === this.focusedIndex && i !== this.inspectedIndex);
                    col.classList.toggle('is-inspected', i === this.inspectedIndex);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const scopeContainer = document.getElementById('scope-root');
            const scopeComponent = new GenomaScope(scopeContainer);
            scopeComponent.loadData();
        });
    </script>
</body>
</html>
