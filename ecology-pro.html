<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>ARKADU Ecology Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--void:#0a0e1a;--panel:#0f1419;--grid:#1a3a52;--text:#b8dbd9;--dim:#6b8a96;
--blue:#4dd9cc;--coral:#d97b8f;--amber:#e8b849;--purple:#9d7be8;--green:#6bbd8f;
}
body{background:var(--void);color:var(--text);font-family:'Courier New',monospace;overflow:hidden;height:100vh}
.app{display:grid;grid-template-columns:260px 1fr 320px;grid-template-rows:54px 1fr 42px;height:100vh;gap:1px;background:var(--grid)}
.hdr{grid-column:1/-1;background:var(--panel);padding:0 14px;display:flex;align-items:center;justify-content:space-between}
.brand{font-size:15px;font-weight:bold;color:var(--blue)}
.mode-btns{display:flex;gap:6px}
.mode-btn{padding:6px 12px;background:var(--void);border:1px solid var(--grid);color:var(--text);cursor:pointer;font-size:10px;border-radius:5px;font-family:inherit}
.mode-btn.active{background:var(--blue);color:var(--void);border-color:var(--blue)}
.stats{font-size:10px;color:var(--dim);display:flex;gap:10px}

/* LEFT: Tree Explorer */
.tree{background:var(--panel);overflow-y:auto;padding:12px}
.tree-title{font-size:10px;text-transform:uppercase;color:var(--dim);margin-bottom:10px;font-weight:bold}
.tree-node{margin-left:12px;font-size:11px;cursor:pointer;padding:4px 6px;border-left:1px solid var(--grid)}
.tree-node:hover{background:rgba(77,217,204,.1)}
.tree-node.active{background:rgba(77,217,204,.2);color:var(--blue)}
.tree-toggle{display:inline-block;width:12px;text-align:center;cursor:pointer;user-select:none}
.tree-children{margin-left:14px;border-left:1px solid var(--grid);padding-left:4px}
.tree-children.collapsed{display:none}
.tree-icon{display:inline-block;width:16px;font-size:9px}

/* CENTER: Stage */
.stage{position:relative;overflow:hidden;background:var(--void)}
.view-mode{position:absolute;inset:0;display:none}
.view-mode.active{display:block}

/* DECK VIEW (default) */
.deck-container{position:absolute;inset:0;padding:16px}
.deck-grid{position:relative;height:100%;border-radius:8px;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:20px 20px;overflow:auto}
.deck-label{position:absolute;top:12px;left:12px;background:rgba(10,14,26,.9);padding:8px 12px;border-radius:6px;font-size:11px;border:1px solid var(--grid);z-index:100}

/* SIDE VIEW (90¬∞ rotation) */
.side-view{position:absolute;inset:0;padding:20px;overflow:auto}
.layer{position:relative;height:180px;margin:20px 0;border:1px solid var(--grid);border-radius:8px;background:rgba(15,20,25,.5);padding:12px}
.layer-title{position:absolute;top:-10px;left:12px;background:var(--panel);padding:4px 10px;font-size:10px;color:var(--blue);border:1px solid var(--grid);border-radius:4px}
.layer-content{display:flex;gap:6px;flex-wrap:wrap;padding-top:16px}

/* OVERVIEW MAP */
.overview{position:absolute;inset:0;padding:30px;overflow:auto}
.kingdom-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.kingdom-card{background:var(--panel);border:1px solid var(--grid);border-radius:8px;padding:14px;cursor:pointer;transition:all .2s}
.kingdom-card:hover{border-color:var(--blue);box-shadow:0 0 20px rgba(77,217,204,.2)}
.kingdom-name{font-size:14px;font-weight:bold;color:var(--blue);margin-bottom:8px}
.kingdom-stats{font-size:10px;color:var(--dim);margin-top:6px}

/* Grains (sized by file size) */
.grain{position:absolute;width:9px;height:9px;border-radius:3px;cursor:pointer;transition:transform .12s,box-shadow .12s;display:flex;align-items:center;justify-content:center;font-size:6px;color:rgba(255,255,255,.8)}
.grain:hover{transform:scale(1.5);box-shadow:0 0 12px currentColor;z-index:1000}
.grain.tiny{width:6px;height:6px}
.grain.small{width:10px;height:10px}
.grain.medium{width:16px;height:16px}
.grain.large{width:24px;height:24px}
.grain.huge{width:36px;height:36px}
.grain[data-s="png"],.grain[data-s="jpg"]{background:var(--blue)}
.grain[data-s="mp4"]{background:var(--coral)}
.grain[data-s="mp3"],.grain[data-s="py"]{background:var(--amber)}
.grain[data-s="json"]{background:var(--purple)}
.grain[data-s="html"]{background:var(--green)}

/* Connection lines */
svg.connections{position:absolute;inset:0;pointer-events:none;z-index:50}
.link{fill:none;stroke-width:2;opacity:.7}
.link.generates{stroke:var(--coral)}
.link.reads{stroke:var(--blue)}
.link.transforms{stroke:var(--amber)}
.link.ekphrasis{stroke:var(--purple);stroke-width:3;stroke-dasharray:5,5}

/* RIGHT: Inspector + Controls */
.inspector{background:var(--panel);overflow-y:auto;padding:14px}
.insp-title{font-size:11px;color:var(--blue);font-weight:bold;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--grid)}
.insp-sec{margin-bottom:14px;font-size:10px;line-height:1.6}
.insp-sec label{display:block;color:var(--dim);font-size:9px;text-transform:uppercase;margin-top:8px;margin-bottom:4px}
.chain-viz{background:rgba(77,217,204,.05);border:1px solid var(--grid);border-radius:6px;padding:10px;margin:6px 0}
.chain-step{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:10px}
.chain-arrow{color:var(--purple);font-weight:bold}
.chain-file{padding:4px 8px;background:rgba(77,217,204,.1);border:1px solid var(--grid);border-radius:4px;cursor:pointer}
.chain-file:hover{background:rgba(77,217,204,.2)}
.prompt-box{background:rgba(157,123,232,.1);border-left:3px solid var(--purple);padding:8px;margin:6px 0;font-size:9px;font-style:italic;color:var(--purple)}

.controls-sec{margin-top:20px;padding-top:14px;border-top:1px solid var(--grid)}
.ctrl-group{margin-bottom:12px}
.ctrl-label{font-size:9px;text-transform:uppercase;color:var(--dim);margin-bottom:6px}
.toggle-list{display:flex;flex-direction:column;gap:4px}
.toggle-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:4px;cursor:pointer;font-size:10px}
.toggle-item:hover{background:rgba(77,217,204,.08)}
.toggle-box{width:14px;height:14px;border:1px solid var(--grid);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px}
.toggle-box.on{background:var(--blue);border-color:var(--blue);color:var(--void)}
.size-slider{width:100%;margin-top:6px}

.ftr{grid-column:1/-1;background:var(--panel);padding:0 14px;display:flex;align-items:center;justify-content:space-between;font-size:10px;color:var(--dim)}
.breadcrumb{color:var(--blue)}

.loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:var(--void);color:var(--blue);font-size:13px;z-index:2000}
.loading.hidden{display:none}
</style>
</head><body>
<div class="app">
<header class="hdr">
<div class="brand">ARKADU ECOLOGY PRO</div>
<div class="mode-btns">
<button class="mode-btn active" onclick="setView('deck')" id="vDeck">DECK</button>
<button class="mode-btn" onclick="setView('side')" id="vSide">SIDE</button>
<button class="mode-btn" onclick="setView('overview')" id="vOver">MAP</button>
</div>
<div class="stats"><span id="sc">0 chambers</span><span id="sa">0 artifacts</span><span id="sz">0 GB</span></div>
</header>

<aside class="tree">
<div class="tree-title">File Explorer</div>
<div id="treeRoot"></div>
</aside>

<main class="stage">
<div class="loading" id="loading">Loading ARKADU ecology...</div>

<!-- DECK VIEW -->
<div class="view-mode active" id="deckView">
<div class="deck-container">
<div class="deck-grid" id="deckGrid"></div>
<div class="deck-label"><strong id="deckTitle">DECK 0</strong> ‚Äî <span id="deckName">ROOT</span></div>
</div>
<svg class="connections" id="svgDeck"></svg>
</div>

<!-- SIDE VIEW (rotated 90¬∞) -->
<div class="view-mode" id="sideView">
<div class="side-view" id="sideContainer"></div>
<svg class="connections" id="svgSide"></svg>
</div>

<!-- OVERVIEW MAP -->
<div class="view-mode" id="overviewView">
<div class="overview"><div class="kingdom-grid" id="kingdomGrid"></div></div>
</div>
</main>

<aside class="inspector">
<div class="insp-title">INSPECTOR</div>
<div id="inspContent"><div style="color:var(--dim);font-style:italic;font-size:10px">Select a grain to inspect</div></div>

<div class="controls-sec">
<div class="ctrl-group">
<div class="ctrl-label">Connection Types</div>
<div class="toggle-list" id="connToggles"></div>
</div>
<div class="ctrl-group">
<div class="ctrl-label">Grain Size Scale</div>
<input type="range" class="size-slider" id="sizeScale" min="0.5" max="3" step="0.1" value="1">
</div>
<div class="ctrl-group">
<div class="ctrl-label">Max Grains Per Species</div>
<input type="range" class="size-slider" id="maxGrains" min="50" max="500" step="50" value="200">
</div>
</div>
</aside>

<footer class="ftr">
<div class="breadcrumb" id="bc">/</div>
<div id="status">Ready</div>
</footer>
</div>

<script>
const S={view:'deck',chambers:[],artifacts:[],chains:[],current:null,sel:null,conn:{generates:true,reads:true,transforms:true,ekphrasis:true},sizeScale:1,maxGrains:200};

async function loadData(){
try{
console.log('Loading...');
const r=await fetch('/sys/primitive.jsonl');
const t=await r.text();
S.artifacts=t.trim().split('\n').map(l=>JSON.parse(l));
console.log(`Loaded ${S.artifacts.length} artifacts`);

try{
const cr=await fetch('/sys/ekphrasis.jsonl');
const ct=await cr.text();
S.chains=ct.trim().split('\n').map(l=>JSON.parse(l));
console.log(`Loaded ${S.chains.length} chains`);
}catch(e){console.log('No chains');S.chains=[];}

buildChambers();
init();
}catch(e){
console.error(e);
document.getElementById('loading').innerHTML=`<div style="color:var(--coral)">ERROR: ${e.message}<br>Use http://localhost:8001/ecology-pro.html</div>`;
}}

function buildChambers(){
const m={};
S.artifacts.forEach(a=>{
const p=a.path.split('/');
for(let d=1;d<=Math.min(p.length-1,3);d++){
const cp=p.slice(0,d).join('/');
if(!m[cp]){
m[cp]={id:cp,name:p[d-1],depth:d-1,parent:d>1?p.slice(0,d-1).join('/'):null,children:[],artifacts:[],species:{},totalSize:0};
}
if(d===p.length-1){
m[cp].artifacts.push(a);
const s=(a.ext||'unknown').replace(/^\./, '');
m[cp].species[s]=(m[cp].species[s]||0)+1;
m[cp].totalSize+=(a.size||0);
}
}
});
Object.values(m).forEach(c=>{
if(c.parent&&m[c.parent]){
if(!m[c.parent].children.includes(c.id))m[c.parent].children.push(c.id);
}
});
S.chambers=Object.values(m);
console.log(`Built ${S.chambers.length} chambers`);
}

function init(){
document.getElementById('loading').classList.add('hidden');
const k=S.chambers.filter(c=>c.depth===0).sort((a,b)=>b.artifacts.length-a.artifacts.length);
S.current=k[0]?.id||S.chambers[0]?.id;
renderTree();
renderDeckView();
renderConnToggles();
updateStats();
setupCtrls();
}

function getCh(id){return S.chambers.find(c=>c.id===id);}

function renderTree(){
const root=document.getElementById('treeRoot');
const kingdoms=S.chambers.filter(c=>c.depth===0).sort((a,b)=>b.artifacts.length-a.artifacts.length);
root.innerHTML=kingdoms.map(k=>renderTreeNode(k,0)).join('');
}

function renderTreeNode(ch,level){
const kids=ch.children||[];
const hasKids=kids.length>0;
const icon=hasKids?'üìÅ':'üìÑ';
let html=`<div class="tree-node ${ch.id===S.current?'active':''}" onclick="jumpTo('${ch.id}')" data-id="${ch.id}">`;
if(hasKids){
html+=`<span class="tree-toggle" onclick="event.stopPropagation();toggleNode('${ch.id}')">‚ñ∂</span>`;
}else{
html+=`<span class="tree-toggle"></span>`;
}
html+=`<span class="tree-icon">${icon}</span> ${ch.name} <span style="color:var(--dim);font-size:9px">(${ch.artifacts.length})</span></div>`;
if(hasKids){
html+=`<div class="tree-children collapsed" id="ch-${ch.id.replace(/\./g,'-')}">`;
kids.forEach(cid=>{
const child=getCh(cid);
if(child)html+=renderTreeNode(child,level+1);
});
html+=`</div>`;
}
return html;
}

function toggleNode(id){
const el=document.getElementById('ch-'+id.replace(/\./g,'-'));
if(el){
el.classList.toggle('collapsed');
const toggle=document.querySelector(`[onclick*="toggleNode('${id}')"]`);
if(toggle)toggle.textContent=el.classList.contains('collapsed')?'‚ñ∂':'‚ñº';
}
}

function jumpTo(id){
S.current=id;
document.querySelectorAll('.tree-node').forEach(n=>n.classList.remove('active'));
const node=document.querySelector(`.tree-node[data-id="${id}"]`);
if(node)node.classList.add('active');
renderDeckView();
updateBC();
}

function renderDeckView(){
const grid=document.getElementById('deckGrid');
grid.innerHTML='';
const ch=getCh(S.current);
if(!ch)return;

document.getElementById('deckTitle').textContent=`DECK ${ch.depth}`;
document.getElementById('deckName').textContent=ch.name;

const species={...ch.species};
let x=80,y=100;
const maxW=1200;

Object.entries(species).forEach(([sp,cnt])=>{
const arts=ch.artifacts.filter(a=>(a.ext||'unknown').replace(/^\./,'')===sp);
const toShow=Math.min(arts.length,S.maxGrains);

for(let i=0;i<toShow;i++){
const art=arts[i];
const grain=document.createElement('div');
grain.className='grain '+getSizeClass(art.size||0);
grain.dataset.s=sp;
grain.dataset.id=art.path;
grain.title=art.name;

const jitter=Math.random()*40-20;
grain.style.left=(x+jitter)+'px';
grain.style.top=(y+jitter)+'px';

grain.onclick=()=>selectGrain(art);
grid.appendChild(grain);

x+=18*S.sizeScale;
if(x>maxW){x=80;y+=60;}
}

x+=120;
if(x>maxW){x=80;y+=100;}
});

drawConnections('svgDeck');
}

function getSizeClass(bytes){
const kb=bytes/1024;
if(kb<10)return 'tiny';
if(kb<100)return 'small';
if(kb<1000)return 'medium';
if(kb<10000)return 'large';
return 'huge';
}

function setView(v){
S.view=v;
const viewMap={deck:'deckView',side:'sideView',overview:'overviewView'};
const btnMap={deck:'vDeck',side:'vSide',overview:'vOver'};
Object.keys(viewMap).forEach(key=>{
const viewEl=document.getElementById(viewMap[key]);
const btnEl=document.getElementById(btnMap[key]);
if(viewEl)viewEl.classList.toggle('active',key===v);
if(btnEl)btnEl.classList.toggle('active',key===v);
});
if(v==='side')renderSideView();
if(v==='overview')renderOverview();
}

function renderSideView(){
const cont=document.getElementById('sideContainer');
cont.innerHTML='';
const depths=[0,1,2];
depths.forEach(d=>{
const chambers=S.chambers.filter(c=>c.depth===d);
if(chambers.length===0)return;

const layer=document.createElement('div');
layer.className='layer';
const title=document.createElement('div');
title.className='layer-title';
title.textContent=`DEPTH ${d} (${chambers.reduce((s,c)=>s+c.artifacts.length,0)} artifacts)`;
layer.appendChild(title);

const content=document.createElement('div');
content.className='layer-content';

chambers.forEach(ch=>{
Object.entries(ch.species).forEach(([sp,cnt])=>{
const arts=ch.artifacts.filter(a=>(a.ext||'unknown').replace(/^\./,'')===sp);
const toShow=Math.min(arts.length,50);
for(let i=0;i<toShow;i++){
const art=arts[i];
const grain=document.createElement('div');
grain.className='grain '+getSizeClass(art.size||0);
grain.dataset.s=sp;
grain.dataset.id=art.path;
grain.dataset.depth=d;
grain.title=art.name;
grain.onclick=()=>selectGrain(art);
grain.style.position='relative';
content.appendChild(grain);
}
});
});

layer.appendChild(content);
cont.appendChild(layer);
});

drawConnections('svgSide');
}

function renderOverview(){
const grid=document.getElementById('kingdomGrid');
const kingdoms=S.chambers.filter(c=>c.depth===0).sort((a,b)=>b.artifacts.length-a.artifacts.length);
grid.innerHTML=kingdoms.map(k=>`
<div class="kingdom-card" onclick="jumpTo('${k.id}');setView('deck')">
<div class="kingdom-name">${k.name}</div>
<div style="font-size:10px;color:var(--dim);margin:6px 0">${k.artifacts.length.toLocaleString()} artifacts</div>
<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px">
${Object.entries(k.species).map(([s,c])=>`<span style="font-size:9px;padding:3px 6px;background:rgba(77,217,204,.1);border-radius:4px;color:${getSpecCol(s)}">${s} (${c})</span>`).join('')}
</div>
<div class="kingdom-stats">${(k.totalSize/1024/1024/1024).toFixed(2)} GB ‚Ä¢ Depth ${k.depth}</div>
</div>
`).join('');
}

function getSpecCol(s){
const cols={png:'var(--blue)',jpg:'var(--blue)',mp4:'var(--coral)',mp3:'var(--amber)',json:'var(--purple)',py:'var(--amber)',html:'var(--green)'};
return cols[s]||'var(--dim)';
}

function selectGrain(art){
S.sel=art;
const insp=document.getElementById('inspContent');
const chain=S.chains.find(c=>c.prompt_file===art.path||c.script===art.path||c.output_files?.includes(art.path));

insp.innerHTML=`
<div class="insp-sec">
<label>Name</label>${art.name}
<label>Path</label>${art.path}
<label>Species</label>${((art.ext||'unknown').replace(/^\./,'')).toUpperCase()}
<label>Size</label>${(art.size/1024).toFixed(1)} KB
<label>Chamber</label>${art.path.split('/').slice(0,-1).join('/')}
</div>
${chain?`
<div class="insp-sec">
<div style="color:var(--purple);font-weight:bold;margin-bottom:8px">üîó Ekphrasis Chain</div>
<div class="chain-viz">
<div class="chain-step">
<span class="chain-file" onclick="jumpToFile('${chain.prompt_file}')">${chain.prompt_file.split('/').pop()}</span>
<span class="chain-arrow">‚Üí</span>
<span class="chain-file" onclick="jumpToFile('${chain.script}')">${chain.script.split('/').pop()}</span>
${chain.uses_ffmpeg?'<span class="chain-arrow">‚Üí</span><span style="color:var(--coral)">ffmpeg</span>':''}
</div>
${chain.sample_prompts&&chain.sample_prompts.length>0?`<div class="prompt-box">"${chain.sample_prompts[0].substring(0,120)}..."</div>`:''}
</div>
</div>
`:''}
`;

drawConnections(S.view==='side'?'svgSide':'svgDeck');
document.getElementById('status').textContent='Selected: '+art.name;
}

function renderConnToggles(){
const cont=document.getElementById('connToggles');
cont.innerHTML=['generates','reads','transforms','ekphrasis'].map(t=>`
<div class="toggle-item" onclick="toggleConn('${t}')">
<div class="toggle-box ${S.conn[t]?'on':''}" id="tog-${t}">${S.conn[t]?'‚úì':''}</div>
<div>${t.toUpperCase()}</div>
</div>
`).join('');
}

function toggleConn(type){
S.conn[type]=!S.conn[type];
document.getElementById('tog-'+type).innerHTML=S.conn[type]?'‚úì':'';
document.getElementById('tog-'+type).classList.toggle('on',S.conn[type]);
drawConnections(S.view==='side'?'svgSide':'svgDeck');
}

function drawConnections(svgId){
const svg=document.getElementById(svgId);
svg.innerHTML='';
if(!S.sel)return;

const links=[];
S.chains.forEach(ch=>{
if(ch.prompt_file===S.sel.path||ch.script===S.sel.path){
if(S.conn.ekphrasis){
links.push({from:ch.prompt_file,to:ch.script,type:'ekphrasis'});
if(ch.output_files)ch.output_files.forEach(o=>links.push({from:ch.script,to:o,type:'generates'}));
}
}
});

links.forEach(L=>{
const A=getGrainPos(L.from);
const B=getGrainPos(L.to);
if(!A||!B)return;
const p=document.createElementNS('http://www.w3.org/2000/svg','path');
p.setAttribute('d',`M ${A.x},${A.y} C ${A.x+(B.x-A.x)*.25},${A.y} ${B.x-(B.x-A.x)*.25},${B.y} ${B.x},${B.y}`);
p.setAttribute('class','link '+L.type);
svg.appendChild(p);
});
}

function getGrainPos(path){
const svg=document.getElementById(S.view==='side'?'svgSide':'svgDeck');
const svgR=svg.getBoundingClientRect();
const el=document.querySelector(`.grain[data-id="${CSS.escape(path)}"]`);
if(!el)return null;
const r=el.getBoundingClientRect();
return{x:r.left-svgR.left+r.width/2,y:r.top-svgR.top+r.height/2};
}

function updateStats(){
document.getElementById('sc').textContent=S.chambers.length+' chambers';
document.getElementById('sa').textContent=S.artifacts.length.toLocaleString()+' artifacts';
const totalSize=S.chambers.reduce((s,c)=>s+c.totalSize,0);
document.getElementById('sz').textContent=(totalSize/1024/1024/1024).toFixed(2)+' GB';
}

function updateBC(){
const ch=getCh(S.current);
if(!ch)return;
const trail=[];
let c=ch;
while(c){
trail.unshift(c.name);
c=c.parent?getCh(c.parent):null;
}
document.getElementById('bc').textContent='/'+trail.join('/');
}

function setupCtrls(){
document.getElementById('sizeScale').oninput=e=>{
S.sizeScale=parseFloat(e.target.value);
renderDeckView();
};
document.getElementById('maxGrains').oninput=e=>{
S.maxGrains=parseInt(e.target.value);
renderDeckView();
};
}

function jumpToFile(path){
const parts=path.split('/');
const chamberId=parts.slice(0,-1).join('/');
const chamber=getCh(chamberId);
if(chamber){
jumpTo(chamber.id);
const art=S.artifacts.find(a=>a.path===path);
if(art)setTimeout(()=>selectGrain(art),100);
}
}

loadData();
</script>
</body></html>
